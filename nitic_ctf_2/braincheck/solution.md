## braincheck
このプログラムは入力されたフラグをチェックします。  
[braincheck.zip](files/braincheck.zip)

## Solution
brainf*ckで書かれた`source.fb`というファイルを渡される。
[Brainf**k Online](https://www.tutorialspoint.com/execute_brainfk_online.php)等で試しに実行してみると、適当な標準入力を要求された後に`Wrong`という文字列が表示される。
プログラム中でflagをチェックして`Wrong`なりを表示しているので、どうにか解析する。

brainf*ckにおいては`,`は入力なので、入力ごとに見ていく
```
>
,>
,[>+>+<<-]>>[<<+>>-]<<[-<->]<-----[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>+++++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++[<----->-]<-[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<------[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<----[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<--[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>+++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<----[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++[<----->-]<----[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>+++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++[<----->-]<--[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<--[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<----[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<-[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>+++[<----->-]<[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++++++++++++++++++++++++++++++++++++++++++++++[<----->-]<---[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<---------[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<------[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>+++++++[<----->-]<-[<+>[-]]>>[<<+>>-]<
,[>+>+<<-]>>[<<+>>-]<<[-<->]<>++++++++++++++++++++++++++++++++++++++[<----->-]<----[<+>[-]]>>[<<+>>-]<
,>>+<<<[-]<[[-]>+++++++++++++++++[<+++++>-]<++.>+++++[<+++++>-]<++.---.-.-------.>>>>-<<<<[-]]>>>>[[-]>+++++++++++++[<+++++>-]<++.>++++++++[<+++++>-]<++++.+++..>++[<----->-]<---.--.>+++[<+++++>-]<++.[-]]
```

最初に2文字入力させて、`.`が多くある最終行で`Wrong`なりを表示、それ以外の行でフラグをチェックしてるっぽい見当がつく。
[brainfuck-visualizer](https://fatiherikli.github.io/brainfuck-visualizer/#)や[オンラインBrainf*ckデバッガ](http://moon.kmc.gr.jp/~prime/brainf_ck/env/)等で内容を見ていくと
- `[<+>[-]]`の`[`が評価される時のポインタが指し示す要素が`0`でない場合、先頭の要素に1加算される
- 先頭の要素が`0`であるかどうかでフラグの正誤を判断している
  - よって、`[<+>[-]]`の`[`が評価される直前までに指し示す要素を`0`にすることを目指す

また、`[>+>+<<-]>>[<<+>>-]<<[-<->]<`で共通した処理を行っている かつ `[<+>[-]]`の直前でチェックしてっるっぽいので  
`[>+>+<<-]>>[<<+>>-]<<[-<->]<`と`[<+>[-]]`で囲まれた部分を見ていくと  
- 3行目では`n(0x6e)`(`nitic_ctf{`の`n`)から`-`の個数分引いて`i(0x69)`
- 4行目では`i(0x69)`に、`+`の個数分 x 5(`[<----->-]`) + `<`以降の`-`の個数分 を足して(+オーバーフロー分を考慮して)`t(0x74)`

最終的には、以下のようなもの書いて一文字ずつ求めた
```python
if __name__ == '__main__':
    before = input("before:? ") #前の文字
    mode = input("mode:? ")
    if mode == "m": # 3行目のようなパターン
        diff = input("diff:? ") # -の個数
        ans = ord(before) - int(diff)
        print("hex:{} chr:{}".format(hex(ans), chr(ans)))
    else: # 4行目のようなパターン
        plus = input("plus:? ") # +の個数
        minus = input("minus:? ") # >以降の-の個数
        ans = ord(before) + (256 - (int(plus) * 5 + int(minus))) #オーバーフロー(?)分を考慮して計算
        print("hex:{} chr:{}".format(hex(ans), chr(ans)))
        if len(hex(ans)) >= 5: # 0x169 -> 0x69にしたかったが、やり方わからんかった
            print("===== CAUTION =====")
            print("may be wrong")

```

`nitic_ctf{esoteric?}`


